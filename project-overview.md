# 📱 Customer Map PWA - プロジェクト解説

---

## 🎯 プロジェクト概要

**お客様情報を地図上で管理する Progressive Web App (PWA)**

- 📍 顧客データの地図表示
- 📷 カメラ機能
- 🔔 プッシュ通知
- 📶 オフライン対応

---

## 🏗️ システム構成図

```
┌─────────────────────────────────────────────────────────────┐
│                    🌐 Frontend (PWA)                        │
├─────────────────────────────────────────────────────────────┤
│  📱 index.html                                              │
│  ├─ ヘッダー（タイトル・ボタン）                              │
│  ├─ サイドバー（顧客リスト）                                 │  
│  ├─ メイン（地図表示）                                       │
│  └─ カメラモーダル                                          │
└─────────────────────────────────────────────────────────────┘
             ↓ JavaScript クラス構成
┌─────────────────────────────────────────────────────────────┐
│              📋 CustomerMapApp クラス                        │
├─────────────────────────────────────────────────────────────┤
│  🗺️ 地図機能 (Leaflet.js)                                   │
│  ├─ OpenStreetMap タイル表示                                │
│  ├─ マーカー表示・選択                                       │
│  └─ ズーム・パン操作                                         │
│                                                             │
│  📷 カメラ機能                                               │
│  ├─ getUserMedia() でアクセス                               │
│  ├─ フロント/バックカメラ切替                                 │
│  ├─ 写真撮影・保存                                          │
│  └─ HTTPS必須（iOS対応）                                    │
│                                                             │
│  🔔 通知機能                                                │
│  ├─ Notification API                                       │
│  ├─ Service Worker 連携                                    │
│  └─ ネイティブアプリ bridge                                  │
│                                                             │
│  📶 オフライン対応                                           │
│  ├─ localStorage キャッシュ                                 │
│  ├─ ネットワーク状態監視                                     │
│  └─ オフライン表示切替                                       │
└─────────────────────────────────────────────────────────────┘
             ↓ データレイヤー  
┌─────────────────────────────────────────────────────────────┐
│                  📊 CustomerAPI クラス                       │
├─────────────────────────────────────────────────────────────┤
│  🏢 顧客データ管理                                           │
│  ├─ モックデータ (5件のサンプル顧客)                         │
│  ├─ 東京都内の住所・緯度経度                                 │
│  └─ localStorage キャッシュ (24時間有効)                     │
│                                                             │
│  🌍 ジオコーディング                                         │
│  ├─ OpenStreetMap Nominatim API                            │  
│  ├─ 住所 → 緯度経度変換                                     │
│  └─ 日本国内限定検索                                         │
│                                                             │
│  💾 キャッシュ戦略                                           │
│  ├─ オンライン: API → localStorage                         │
│  ├─ オフライン: localStorage → 表示                        │
│  └─ エラー時: キャッシュフォールバック                        │
└─────────────────────────────────────────────────────────────┘
             ↓ Service Worker レイヤー
┌─────────────────────────────────────────────────────────────┐
│              ⚙️ Service Worker (sw.js)                      │
├─────────────────────────────────────────────────────────────┤
│  📦 キャッシュ戦略                                           │
│  ├─ static-v2: HTML/CSS/JS (Cache First)                   │
│  ├─ dynamic-v2: その他リソース (Network First)              │
│  └─ api-v2: API レスポンス (Network First + Cache)         │
│                                                             │
│  🔔 プッシュ通知                                             │
│  ├─ 通知受信・表示                                          │
│  ├─ 通知クリック処理                                         │
│  └─ アプリ復帰・フォーカス                                   │
│                                                             │
│  📶 オフライン処理                                           │
│  ├─ ネットワークエラー時のキャッシュ返却                      │
│  ├─ 静的アセット判定                                         │
│  └─ APIエラー時のフォールバック                              │
└─────────────────────────────────────────────────────────────┘
             ↓ PWA設定
┌─────────────────────────────────────────────────────────────┐
│                📱 PWA Manifest (manifest.json)              │
├─────────────────────────────────────────────────────────────┤
│  🎨 アプリ外観                                               │
│  ├─ 名前: "Customer Map App"                               │
│  ├─ テーマカラー: #2196F3 (青)                              │
│  ├─ 表示モード: standalone                                  │
│  └─ 向き: portrait-primary                                 │
│                                                             │
│  🖼️ アイコン・スクリーンショット                              │
│  ├─ SVG形式のアプリアイコン                                  │
│  ├─ 192x192, 512x512サイズ                                 │
│  └─ インストール用スクリーンショット                          │
│                                                             │
│  🌐 PWA設定                                                 │
│  ├─ スコープ: "/"                                           │
│  ├─ 言語: 日本語                                            │
│  └─ カテゴリ: business, productivity                        │
└─────────────────────────────────────────────────────────────┘
```

---

## 💡 主要機能フロー

### 🗺️ **地図表示フロー**
```
アプリ起動
    ↓
Leaflet.js 初期化 
    ↓
東京中心の地図表示
    ↓
CustomerAPI.getCustomers()
    ↓
オンライン？
├─ YES → API呼び出し → キャッシュ保存
└─ NO  → localStorage読み込み
    ↓
顧客データを地図にマーカー表示
    ↓
マーカークリック → 顧客詳細ポップアップ
```

### 📷 **カメラ機能フロー**
```
カメラボタンクリック
    ↓  
HTTPS接続チェック
    ↓
getUserMedia() 権限要求
    ↓
カメラストリーム取得
    ↓
モーダル表示・プレビュー開始
    ↓
撮影ボタン → Canvas に描画
    ↓
JPEG形式で保存・ダウンロード
```

### 🔔 **通知機能フロー**
```
通知有効ボタンクリック
    ↓
Notification.requestPermission()
    ↓
許可された？
├─ YES → ローカル通知有効化
└─ NO  → エラーメッセージ
    ↓
テスト通知送信
    ↓
Service Worker で通知表示
```

---

## 🛠️ 技術スタック

### **Frontend**
- 🌐 **HTML5** - セマンティックなマークアップ
- 🎨 **CSS3** - レスポンシブデザイン
- ⚡ **Vanilla JavaScript** - フレームワーク不使用
- 🗺️ **Leaflet.js** - オープンソース地図ライブラリ

### **PWA機能** 
- 📦 **Service Worker** - オフライン・キャッシュ
- 📱 **Web App Manifest** - インストール可能
- 🔔 **Push API** - プッシュ通知
- 📷 **MediaDevices API** - カメラアクセス

### **データ・API**
- 🌍 **OpenStreetMap** - 地図タイル
- 🌐 **Nominatim API** - ジオコーディング
- 💾 **localStorage** - ローカルキャッシュ
- 📊 **Mock Data** - サンプル顧客データ

---

## 🎯 PWA特徴

### ✅ **オフライン対応**
- Service Worker による静的リソースキャッシュ
- API レスポンスのキャッシュ戦略
- ネットワーク状態の自動検知・表示

### ✅ **インストール可能**
- ホーム画面への追加
- ネイティブアプリライクな体験
- スプラッシュスクリーン表示

### ✅ **レスポンシブデザイン**
- スマートフォン・タブレット対応
- タッチ操作最適化
- PWA標準のビューポート設定

### ✅ **プッシュ通知**
- ローカル通知サポート
- Service Worker による通知管理
- ネイティブアプリ bridge 対応

---

## 📋 ファイル構成

```
PWAtest3/
├── 📄 index.html          # メインHTML
├── 🎨 styles.css          # スタイルシート  
├── ⚡ app.js              # メインJavaScript
├── 📊 api.js              # API・データ管理
├── ⚙️ sw.js               # Service Worker
├── 📱 manifest.json       # PWA Manifest
├── 🔐 cert.pem           # HTTPS証明書
├── 🗝️ key.pem            # HTTPS秘密鍵
└── 📖 README.md          # プロジェクト説明
```

---

## 🚀 実行環境

### **開発サーバー**
- **HTTP**: `http://192.168.43.182:3000`
- **HTTPS**: `https://192.168.43.182:3001` 

### **動作要件**
- ✅ モダンブラウザ (Chrome, Safari, Firefox)
- ✅ HTTPS環境 (カメラ・通知に必須)
- ✅ JavaScript有効
- ✅ ネットワーク接続 (初回読み込み時)

---

## 🎨 デザインシステム

### **カラーパレット**
- 🔵 **プライマリ**: #2196F3 (青)
- ⚪ **背景**: #f5f5f5 (薄グレー)  
- 🔴 **選択**: 赤色マーカー
- ⚠️ **警告**: オフライン表示

### **レイアウト**
- 📱 **モバイルファースト**設計
- 🔄 **フレックスボックス**レイアウト
- 📐 **100vh** フルハイト表示
- 🗂️ **サイドバー** + **メインエリア**構成

---

## 💻 主要コンポーネント

### **CustomerMapApp クラス**
- アプリケーション全体の制御
- 地図・カメラ・通知機能の統合管理
- ネイティブアプリ連携インターフェース

### **CustomerAPI クラス**  
- 顧客データのCRUD操作
- オフライン時のキャッシュ機能
- ジオコーディングAPI連携

### **Service Worker**
- リソースキャッシュ戦略の実装
- プッシュ通知の受信・表示
- オフライン時のフォールバック処理

---

🎉 **このPWAは、モダンなWeb技術を活用して**  
**ネイティブアプリに近い体験を提供する**  
**お客様情報管理システムです！**